name: Code Quality & Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Run Tests with Coverage
      run: mvn clean test jacoco:report

    - name: Coverage Quality Gate
      run: |
        COVERAGE=$(grep -oP '(?<=<counter type="LINE" missed=")[0-9]+' target/site/jacoco/jacoco.xml | head -1)
        TOTAL=$(grep -oP '(?<=<counter type="LINE" missed=")[0-9]+' target/site/jacoco/jacoco.xml | head -2 | tail -1)
        if [ ! -z "$COVERAGE" ] && [ ! -z "$TOTAL" ]; then
          PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", ($TOTAL - $COVERAGE) / $TOTAL * 100}")
          echo "Code Coverage: $PERCENTAGE%"
          
          # Quality gate: minimum 70% coverage
          if (( $(echo "$PERCENTAGE < 70" | bc -l) )); then
            echo "❌ Coverage below 70% threshold"
            exit 1
          fi
          echo "✅ Coverage meets quality gate"
        fi

    - name: Test Quality Gate
      run: |
        if [ -f target/surefire-reports/TEST-*.xml ]; then
          FAILURES=$(grep -o 'failures="[0-9]*"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
          ERRORS=$(grep -o 'errors="[0-9]*"' target/surefire-reports/TEST-*.xml | grep -o '[0-9]*' | awk '{s+=$1} END {print s}')
          
          if [ "$FAILURES" != "0" ] || [ "$ERRORS" != "0" ]; then
            echo "❌ Tests failed: $FAILURES failures, $ERRORS errors"
            exit 1
          fi
          echo "✅ All tests passed"
        fi

    - name: Build Quality Gate
      run: |
        mvn package -DskipTests
        if [ $? -ne 0 ]; then
          echo "❌ Build failed"
          exit 1
        fi
        echo "✅ Build successful"

    - name: Generate Quality Report
      run: |
        mkdir -p quality-reports
        echo "# Quality Report" > quality-reports/summary.md
        echo "" >> quality-reports/summary.md
        echo "## Build Status: ✅ Passed" >> quality-reports/summary.md
        echo "## Test Status: ✅ All tests passed" >> quality-reports/summary.md
        echo "## Coverage: See Codecov" >> quality-reports/summary.md

    - name: Upload Quality Reports
      uses: actions/upload-artifact@v4
      with:
        name: quality-reports
        path: quality-reports/
