name: Dependency Management

on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sundays at midnight UTC
  workflow_dispatch:
  push:
    paths:
      - 'pom.xml'

jobs:
  dependency-updates:
    name: Check Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Check for Dependency Updates
      run: |
        echo "Checking for dependency updates..."
        mvn versions:display-dependency-updates -DoutputFile=dependency-updates.txt
        mvn versions:display-plugin-updates >> dependency-updates.txt
        
        cat dependency-updates.txt

    - name: Check for Security Vulnerabilities
      run: |
        echo "Checking for security vulnerabilities..."
        mvn dependency:tree > dependency-tree.txt
        
        # Note: For comprehensive security scanning, consider using:
        # - OWASP Dependency-Check Maven Plugin
        # - Snyk
        # - GitHub Dependabot (already configured)

    - name: Generate Summary
      run: |
        mkdir -p reports
        
        echo "# üì¶ Dependency Update Report" > reports/summary.md
        echo "" >> reports/summary.md
        echo "**Generated:** $(date)" >> reports/summary.md
        echo "" >> reports/summary.md
        echo "## üîÑ Available Updates" >> reports/summary.md
        echo "" >> reports/summary.md
        
        if grep -q "The following dependencies in Dependencies have newer versions" dependency-updates.txt; then
          echo "‚úÖ Updates available - see detailed report" >> reports/summary.md
        else
          echo "‚úÖ All dependencies are up to date!" >> reports/summary.md
        fi
        
        echo "" >> reports/summary.md
        echo "## üìã Details" >> reports/summary.md
        echo "" >> reports/summary.md
        echo "See the attached artifacts for:" >> reports/summary.md
        echo "- \`dependency-updates.txt\` - List of available updates" >> reports/summary.md
        echo "- \`dependency-tree.txt\` - Full dependency tree" >> reports/summary.md

    - name: Upload Update Report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: |
          dependency-updates.txt
          dependency-tree.txt
          reports/
        retention-days: 30

    - name: Check for Critical Updates
      run: |
        # Check if any dependencies are significantly outdated
        if grep -i "major.*available" dependency-updates.txt; then
          echo "‚ö†Ô∏è  Major version updates available"
          echo "Review the dependency-updates.txt artifact for details"
        fi
        
        if grep -i "minor.*available" dependency-updates.txt; then
          echo "‚ÑπÔ∏è  Minor version updates available"
        fi

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Run Dependency Analysis
      run: |
        echo "Analyzing dependencies for security issues..."
        mvn dependency:analyze > dependency-analysis.txt 2>&1
        
        cat dependency-analysis.txt

    - name: Check for Unused Dependencies
      run: |
        if grep -q "Unused declared dependencies" dependency-analysis.txt; then
          echo "‚ö†Ô∏è  Unused dependencies detected"
          grep -A 10 "Unused declared dependencies" dependency-analysis.txt || true
        else
          echo "‚úÖ No unused dependencies"
        fi

    - name: Check for Undeclared Dependencies
      run: |
        if grep -q "Used undeclared dependencies" dependency-analysis.txt; then
          echo "‚ö†Ô∏è  Undeclared dependencies detected"
          grep -A 10 "Used undeclared dependencies" dependency-analysis.txt || true
        else
          echo "‚úÖ All dependencies properly declared"
        fi

    - name: Upload Analysis Report
      uses: actions/upload-artifact@v4
      with:
        name: security-audit
        path: dependency-analysis.txt
        retention-days: 30

    - name: Create Issue for Critical Updates (Optional)
      if: github.event_name == 'schedule'
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');
          const content = fs.readFileSync('dependency-updates.txt', 'utf8');
          
          // Only create issue if major updates are available
          if (content.includes('major') && content.includes('available')) {
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üì¶ Weekly Dependency Updates Available',
              body: `## Dependency Update Report
              
Major version updates are available. Please review the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.

### What to do:
1. Review the \`dependency-updates.txt\` artifact
2. Update dependencies in \`pom.xml\`
3. Run tests to ensure compatibility
4. Create a PR with the updates

### Automated Check
This issue was automatically created by the weekly dependency check workflow.
              `,
              labels: ['dependencies', 'maintenance']
            });
          }
